services:
  rsa-key-generator:
    image: alpine/openssl:3.5.2
    volumes:
      - rsakeys:/keys
    entrypoint: ["/bin/ash"]
    command: ["-c", "if [ ! -f /keys/private_key.pem ]; then openssl genpkey -algorithm RSA -out /keys/private_key.pem -pkeyopt rsa_keygen_bits:4096; fi && tail -f /dev/null"]
    healthcheck:
      test: ["CMD", "test", "-f", "/keys/private_key.pem"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always

  redis:
    image: redis:8.2.2
    restart: always
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.2
    volumes:
      - esdata:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.ml.enabled=false
      - xpack.security.enabled=false
      - thread_pool.search.queue_size=5000
      - logger.org.elasticsearch.discovery="ERROR"
      - "ES_JAVA_OPTS=-Xms${ELASTIC_MEMORY_SIZE} -Xmx${ELASTIC_MEMORY_SIZE}"
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://elasticsearch:9200/_cluster/health?wait_for_status=yellow >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 50

  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    volumes:
      - s3data:/data
    ports:
      - "9000:9000"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data
    restart: always
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 3

  rabbitmq:
    image: rabbitmq:4.1-management
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
      - RABBITMQ_NODENAME=rabbit01@localhost
    volumes:
      - type: bind
        source: ./rabbitmq.conf
        target: /etc/rabbitmq/rabbitmq.conf
      - amqpdata:/var/lib/rabbitmq
    restart: always
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3

  ###########################
  # OPENCTI                 #
  ###########################
  opencti:
    image: opencti/platform:6.8.12
    environment:
      - NODE_OPTIONS=--max-old-space-size=8096
      - APP__PORT=8080
      - APP__BASE_URL=${OPENCTI_BASE_URL}
      - APP__SECRET=${OPENCTI_SECRET}
      # === LOCAL ADMIN (BREAK-GLASS) ===
      - APP__ADMIN__EMAIL=${OPENCTI_ADMIN_EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_ADMIN_PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_ADMIN_TOKEN}
      - APP__APP_LOGS__LOGS_LEVEL=info
      # === REDIS ===
      - REDIS__HOSTNAME=redis
      - REDIS__PORT=6379
      # === ELASTICSEARCH ===
      - ELASTICSEARCH__URL=http://elasticsearch:9200
      - ELASTICSEARCH__NUMBER_OF_REPLICAS=0
      # === MINIO ===
      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__USE_SSL=false
      - MINIO__ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO__SECRET_KEY=${MINIO_ROOT_PASSWORD}
      # === RABBITMQ ===
      - RABBITMQ__HOSTNAME=rabbitmq
      - RABBITMQ__PORT=5672
      - RABBITMQ__PORT_MANAGEMENT=15672
      - RABBITMQ__MANAGEMENT_SSL=false
      - RABBITMQ__USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - RABBITMQ__VHOST=/
      # === SMTP ===
      - SMTP__HOSTNAME=${SMTP_HOSTNAME}
      - SMTP__PORT=25
      # === AUTH PROVIDERS ===
      - PROVIDERS__LOCAL__STRATEGY=LocalStrategy
      # === LDAP AUTH ===
      - PROVIDERS__LDAP__STRATEGY=LdapStrategy
      - PROVIDERS__LDAP__CONFIG__URL=${AUTH_LDAP_SERVER_URL}
      - PROVIDERS__LDAP__CONFIG__BIND_DN=${AUTH_LDAP_BIND_DN}
      - PROVIDERS__LDAP__CONFIG__BIND_CREDENTIALS=${AUTH_LDAP_BIND_PASSWORD}
      - PROVIDERS__LDAP__CONFIG__SEARCH_BASE=${AUTH_LDAP_BASE_DN}
      - PROVIDERS__LDAP__CONFIG__SEARCH_FILTER=(&(sAMAccountName={{username}})(memberOf=CN=OpenCTI_Users,OU=Admin,OU=Inovacijų ir technologijų grupė,OU=Grupės,OU=VMSA,DC=vilnius,DC=vilnius,DC=lt))
      - PROVIDERS__LDAP__CONFIG__MAIL_ATTRIBUTE=mail
      - PROVIDERS__LDAP__CONFIG__ACCOUNT_ATTRIBUTE=displayName
      - PROVIDERS__LDAP__CONFIG__REFERRALS=false
      # === HEALTHCHECK ===
      - APP__HEALTH_ACCESS_KEY=${OPENCTI_HEALTHCHECK_ACCESS_KEY}
    ports:
      - "8080:8080"
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health?health_access_key=${OPENCTI_HEALTHCHECK_ACCESS_KEY}"]
      interval: 10s
      timeout: 5s
      retries: 20

  worker:
    image: opencti/worker:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - WORKER_LOG_LEVEL=info
    depends_on:
      opencti:
        condition: service_healthy
    deploy:
      mode: replicated
      replicas: 3
    restart: always

  connector-export-file-stix:
    image: opencti/connector-export-file-stix:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_EXPORT_FILE_STIX_ID}
      - CONNECTOR_TYPE=INTERNAL_EXPORT_FILE
      - CONNECTOR_NAME=ExportFileStix2
      - CONNECTOR_SCOPE=application/json
      - CONNECTOR_LOG_LEVEL=info
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-export-file-csv:
    image: opencti/connector-export-file-csv:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_EXPORT_FILE_CSV_ID}
      - CONNECTOR_TYPE=INTERNAL_EXPORT_FILE
      - CONNECTOR_NAME=ExportFileCsv
      - CONNECTOR_SCOPE=text/csv
      - CONNECTOR_LOG_LEVEL=info
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-export-file-txt:
    image: opencti/connector-export-file-txt:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_EXPORT_FILE_TXT_ID}
      - CONNECTOR_TYPE=INTERNAL_EXPORT_FILE
      - CONNECTOR_NAME=ExportFileTxt
      - CONNECTOR_SCOPE=text/plain
      - CONNECTOR_LOG_LEVEL=info
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-import-file-stix:
    image: opencti/connector-import-file-stix:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IMPORT_FILE_STIX_ID}
      - CONNECTOR_TYPE=INTERNAL_IMPORT_FILE
      - CONNECTOR_NAME=ImportFileStix
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=true
      - CONNECTOR_SCOPE=application/json,text/xml
      - CONNECTOR_AUTO=true
      - CONNECTOR_LOG_LEVEL=info
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-import-document:
    image: opencti/connector-import-document:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_IMPORT_DOCUMENT_ID}
      - CONNECTOR_TYPE=INTERNAL_IMPORT_FILE
      - CONNECTOR_NAME=ImportDocument
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=true
      - CONNECTOR_SCOPE=application/pdf,text/plain,text/html
      - CONNECTOR_AUTO=true
      - CONNECTOR_ONLY_CONTEXTUAL=false
      - CONNECTOR_LOG_LEVEL=info
      - IMPORT_DOCUMENT_CREATE_INDICATOR=true
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-analysis:
    image: opencti/connector-import-document:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_ANALYSIS_ID}
      - CONNECTOR_TYPE=INTERNAL_ANALYSIS
      - CONNECTOR_NAME=ImportDocumentAnalysis
      - CONNECTOR_VALIDATE_BEFORE_IMPORT=false
      - CONNECTOR_SCOPE=application/pdf,text/plain,text/html
      - CONNECTOR_AUTO=true
      - CONNECTOR_ONLY_CONTEXTUAL=false
      - CONNECTOR_LOG_LEVEL=info
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  ########## MITRE ##########
  mitre:
    image: opencti/connector-mitre:6.8.12
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=mitre-001
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MITRE ATT&CK
      - CONNECTOR_SCOPE=identity,attack-pattern,malware,intrusion-set,tool,relationship,report,course-of-action,x-mitre-data-component,x-mitre-data-source
      - CONNECTOR_CONFIDENCE_LEVEL=90

      # LABAI SVARBU
      - CONNECTOR_UPDATE_INTERVAL=3600
      - CONNECTOR_LOG_LEVEL=info

      # MITRE dataset selection (NAUJAS formatas)
      - MITRE_ENTERPRISE=true
      - MITRE_MOBILE=true
      - MITRE_ICS=true
      - MITRE_PRE_ATTACK=true

      # Using GitHub dataset
      - MITRE_DATASET_URL=https://raw.githubusercontent.com/mitre/cti/master/

    depends_on:
      opencti:
        condition: service_healthy


  ##########     MISP  ##########
  connector-misp:
    image: opencti/connector-misp:6.8.12
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_MISP_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP
      - CONNECTOR_SCOPE=indicator,malware,attack-pattern,intrusion-set,tool,report,course-of-action
      - CONNECTOR_CONFIDENCE_LEVEL=100
      - CONNECTOR_LOG_LEVEL=info
      - MISP_URL=${MISP_URL}
      - MISP_KEY=${MISP_API_KEY}
      - MISP_SSL_VERIFY=${MISP_SSL_VERIFY}
      - MISP_DATETIME_ATTRIBUTE=timestamp
      - MISP_CREATE_REPORTS=true
      - MISP_CREATE_INDICATORS=true
      - MISP_CREATE_OBSERVABLES=true
      - MISP_IMPORT_ONLY_PUBLISHED=false
      - MISP_IMPORT_TO_IDS_NO_SCORE=0
      - MISP_REPORT_CLASS="MISP Event"
      - MISP_IMPORT_FROM_DATE=2024-01-01
      - MISP_IMPORT_TAGS=
      - MISP_IMPORT_TAGS_NOT=
    restart: always
    depends_on:
      opencti:
        condition: service_healthy


########## SHODAN ##########
  opencti-connector-shodan:
    image: opencti/connector-shodan:6.8.12
    container_name: opencti-connector-shodan
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_SHODAN_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Shodan
      - CONNECTOR_SCOPE=shodan
      - CONNECTOR_CONFIDENCE_LEVEL=70
      - CONNECTOR_LOG_LEVEL=info
      - SHODAN_API_KEY=${SHODAN_API_KEY}
      - SHODAN_BASE_URL=${SHODAN_BASE_URL}
    depends_on:
      - opencti

########## ThreatFOX ##########

  threatfox-connector:
    image: opencti/connector-threatfox:6.8.12
    container_name: threatfox-connector
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=threatfox-connector-01
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=ThreatFox
      - CONNECTOR_SCOPE=indicator
      - CONNECTOR_CONFIDENCE_LEVEL=80
      - CONNECTOR_UPDATE_INTERVAL=3600
      - CONNECTOR_LOG_LEVEL=info
    volumes:
      - ./connectors/threatfox/config.yml:/app/config.yml:ro
    depends_on:
      opencti:
        condition: service_healthy

########## UrlHaus ##########
  opencti-connector-urlhaus:
    image: opencti/connector-urlhaus:6.8.12
    container_name: opencti-connector-urlhaus
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=urlhaus-connector-001
      - CONNECTOR_NAME=URLHaus
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_SCOPE=indicator,url,domain-name,ipv4-addr
      - CONNECTOR_CONFIDENCE_LEVEL=90
      - CONNECTOR_UPDATE_INTERVAL=3600
      - CONNECTOR_LOG_LEVEL=info
    depends_on:
      opencti:
        condition: service_healthy

  ########## CISA KEV ##########
  cisa-kev:
    image: opencti/connector-cisa-known-exploited-vulnerabilities:6.8.12
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=CISA-KEV-001
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=CISA Known Exploited Vulnerabilities
      - CONNECTOR_SCOPE=vulnerability
      - CONNECTOR_CONFIDENCE_LEVEL=90
      - UPDATE_INTERVAL=86400
    depends_on:
      opencti:
        condition: service_healthy

########## AlienVault OTX ##########
  connector-alienvault:
    image: opencti/connector-alienvault:6.8.12
    container_name: opencti-connector-alienvault
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=${CONNECTOR_ALIENVAULT_ID}
      - CONNECTOR_NAME=AlienVault OTX
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_SCOPE=indicator,ipv4-addr,domain-name,hash
      - CONNECTOR_CONFIDENCE_LEVEL=90
      - ALIENVAULT_REPORT_STATUS=new
      - CONNECTOR_LOG_LEVEL=info
      - ALIENVAULT_POLLING_INTERVAL=3600
      - CONNECTOR_RUN_AND_TERMINATE=false
    depends_on:
      opencti:
        condition: service_healthy

########### AbuseIPDB ##########
  opencti-connector-abuseipdb:
    image: opencti/connector-abuseipdb:6.8.12
    container_name: opencti-connector-abuseipdb
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=abuseipdb-001
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=AbuseIPDB
      - CONNECTOR_SCOPE=ipv4-addr,indicator
      - CONNECTOR_CONFIDENCE_LEVEL=80
      - CONNECTOR_UPDATE_INTERVAL=3600
      - CONNECTOR_LOG_LEVEL=info
      - ALIENVAULT_REPORT_STATUS=confirmed
      - ABUSEIPDB_API_KEY=${ABUSEIPDB_API_KEY}
      - ABUSEIPDB_LIMIT=1000
      - ABUSEIPDB_MIN_CONFIDENCE=75
    depends_on:
      opencti:
        condition: service_healthy

########## MalwareBazaar ##########
  malwarebazaar:
    image: opencti/connector-malwarebazaar:6.8.12
    restart: always
    environment:
      - OPENCTI_URL=${OPENCTI_BASE_URL}
      - OPENCTI_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - CONNECTOR_ID=malwarebazaar-001
      - CONNECTOR_NAME=MalwareBazaar
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_SCOPE=malware,indicator
      - CONNECTOR_CONFIDENCE_LEVEL=80
      - CONNECTOR_UPDATE_INTERVAL=3600
      - CONNECTOR_LOG_LEVEL=info
      - MALWAREBAZAAR_API_KEY=dummy
    depends_on:
      opencti:
        condition: service_healthy

volumes:
  esdata:
  s3data:
  redisdata:
  amqpdata:
  rsakeys:
